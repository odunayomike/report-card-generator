import{E as L,u as Y,r as a,A as w,j as e}from"./index.UZcXu8dh.js";const J=()=>{const{examId:p}=L(),S=Y(),[r,E]=a.useState(null),[R,A]=a.useState(null),[n,$]=a.useState([]),[o,_]=a.useState({}),[i,j]=a.useState(0),[T,I]=a.useState(0),[Q,M]=a.useState(!0),[m,f]=a.useState(!1),[h,u]=a.useState(""),[O,y]=a.useState(!1),c=a.useRef(null),d=a.useRef(null),N=a.useRef(null);a.useEffect(()=>(q(),()=>{c.current&&clearTimeout(c.current),d.current&&clearInterval(d.current)}),[p]),a.useEffect(()=>{if(r&&r.started_at){const s=new Date(r.started_at).getTime(),t=r.duration_minutes*60*1e3,g=s+t,x=()=>{const C=Date.now(),v=Math.max(0,g-C);I(Math.floor(v/1e3)),v<=0&&F()};return x(),d.current=setInterval(x,1e3),()=>{d.current&&clearInterval(d.current)}}},[r]);const q=async()=>{try{const t=await(await fetch(`${w}/cbt/student-exams?action=start&exam_id=${p}`,{credentials:"include"})).json();t.success?(E(t.exam),A(t.attempt_id),N.current=t.attempt_id,$(t.questions),_(t.saved_answers||{})):u(t.message||"Failed to start exam")}catch(s){u("Failed to load exam"),console.error("Start exam error:",s)}finally{M(!1)}},P=async(s,t)=>{const g={...o,[s]:t};_(g),c.current&&clearTimeout(c.current),c.current=setTimeout(async()=>{try{if(!N.current){console.error("No attempt ID available for saving");return}const x={action:"save_answer",attempt_id:N.current,question_id:s,selected_option_id:t},v=await(await fetch(`${w}/cbt/student-exams`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(x)})).json()}catch(x){console.error("Auto-save error:",x)}},500)},k=async()=>{f(!0),u("");try{const t=await(await fetch(`${w}/cbt/student-exams`,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({action:"submit",attempt_id:R,answers:o})})).json();t.success?(d.current&&clearInterval(d.current),c.current&&clearTimeout(c.current),r.show_results_immediately==0?S("/student/exams",{state:{message:"Exam submitted successfully! Results will be available later."}}):S(`/student/results/${p}`)):(u(t.message||"Failed to submit exam"),f(!1))}catch(s){u("Failed to submit exam"),f(!1),console.error("Submit exam error:",s)}},F=()=>{m||k()},D=s=>{const t=Math.floor(s/60),g=s%60;return`${t}:${g.toString().padStart(2,"0")}`},b=()=>Object.keys(o).length;if(Q)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto"}),e.jsx("p",{className:"mt-4 text-gray-600",children:"Loading exam..."})]})});if(h&&!r)return e.jsx("div",{className:"flex items-center justify-center min-h-screen",children:e.jsx("div",{className:"bg-red-50 border border-red-400 text-red-700 px-6 py-4 rounded-lg max-w-md",children:h})});const l=n[i];return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b shadow-sm sticky top-0 z-10",children:e.jsx("div",{className:"max-w-6xl mx-auto px-4 py-4",children:e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-bold text-gray-900",children:r.title}),e.jsx("p",{className:"text-sm text-gray-600",children:r.subject})]}),e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Question"}),e.jsxs("p",{className:"text-lg font-semibold",children:[i+1," / ",n.length]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-gray-600",children:"Answered"}),e.jsxs("p",{className:"text-lg font-semibold",children:[b()," / ",n.length]})]}),e.jsxs("div",{className:`text-right px-4 py-2 rounded-lg ${T<300?"bg-red-100 text-red-800":"bg-blue-100 text-blue-800"}`,children:[e.jsx("p",{className:"text-sm font-medium",children:"Time Remaining"}),e.jsx("p",{className:"text-2xl font-bold",children:D(T)})]})]})]})})}),e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8",children:[h&&e.jsx("div",{className:"bg-red-50 border border-red-400 text-red-700 px-4 py-3 rounded mb-6",children:h}),e.jsxs("div",{className:"grid grid-cols-4 gap-6",children:[e.jsx("div",{className:"col-span-1",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-4 sticky top-24",children:[e.jsx("h3",{className:"font-semibold text-gray-900 mb-3",children:"Questions"}),e.jsx("div",{className:"grid grid-cols-5 gap-2",children:n.map((s,t)=>e.jsx("button",{onClick:()=>j(t),className:`w-10 h-10 rounded-lg text-sm font-semibold transition-colors ${t===i?"bg-green-600 text-white":o[s.id]?"bg-green-100 text-green-800":"bg-gray-100 text-gray-600 hover:bg-gray-200"}`,children:t+1},s.id))}),e.jsxs("div",{className:"mt-4 pt-4 border-t text-xs text-gray-600",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-600 rounded"}),e.jsx("span",{children:"Current"})]}),e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-4 h-4 bg-green-100 rounded border border-green-300"}),e.jsx("span",{children:"Answered"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-4 h-4 bg-gray-100 rounded"}),e.jsx("span",{children:"Not answered"})]})]})]})}),e.jsx("div",{className:"col-span-3",children:e.jsxs("div",{className:"bg-white rounded-lg shadow p-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex justify-between items-start mb-4",children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:["Question ",i+1]}),e.jsxs("span",{className:"px-3 py-1 bg-blue-100 text-blue-800 text-sm rounded-full",children:[l.marks," ",l.marks===1?"mark":"marks"]})]}),e.jsx("p",{className:"text-gray-800 text-lg leading-relaxed",children:l.question_text})]}),e.jsx("div",{className:"space-y-3",children:l.options.map(s=>e.jsxs("label",{className:`flex items-start p-4 border-2 rounded-lg cursor-pointer transition-all ${o[l.id]===s.id?"border-green-600 bg-green-50":"border-gray-200 hover:border-gray-300 hover:bg-gray-50"}`,children:[e.jsx("input",{type:"radio",name:`question-${l.id}`,checked:o[l.id]===s.id,onChange:()=>P(l.id,s.id),className:"w-5 h-5 text-green-600 mt-0.5"}),e.jsx("span",{className:"ml-3 text-gray-800",children:s.text})]},s.id))}),e.jsxs("div",{className:"flex justify-between items-center mt-8 pt-6 border-t",children:[e.jsx("button",{onClick:()=>j(Math.max(0,i-1)),disabled:i===0,className:"px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed",children:"← Previous"}),e.jsx("div",{className:"flex gap-3",children:i===n.length-1?e.jsx("button",{onClick:()=>y(!0),disabled:m,className:"px-8 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50",children:m?"Submitting...":"Submit Exam"}):e.jsx("button",{onClick:()=>j(Math.min(n.length-1,i+1)),className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",children:"Next →"})})]})]})})]})]}),O&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-lg max-w-md w-full p-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-4",children:"Submit Exam?"}),e.jsxs("p",{className:"text-gray-600 mb-2",children:["You have answered ",b()," out of ",n.length," questions."]}),b()<n.length&&e.jsxs("p",{className:"text-orange-600 text-sm mb-4",children:["⚠ Warning: You have ",n.length-b()," unanswered question(s)."]}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Once submitted, you cannot change your answers. Are you sure you want to submit?"}),e.jsxs("div",{className:"flex gap-3 justify-end",children:[e.jsx("button",{onClick:()=>y(!1),className:"px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",disabled:m,children:"Cancel"}),e.jsx("button",{onClick:()=>{y(!1),k()},className:"px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700",disabled:m,children:m?"Submitting...":"Yes, Submit"})]})]})})]})};export{J as default};
