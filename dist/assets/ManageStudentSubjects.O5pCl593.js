import{r as l,j as e}from"./index.UZcXu8dh.js";import{z as X,a as Y,k as Z,l as ee,C as se,D as te,E as re,g as le,x as ae}from"./api.CIjYu6Aj.js";const ie=()=>{const[j,P]=l.useState(""),[L,_]=l.useState([]),[b,v]=l.useState([]),[u,S]=l.useState(""),[N,B]=l.useState(""),[f,A]=l.useState([]),[n,w]=l.useState(null),[i,y]=l.useState([]),[d,D]=l.useState(!1),[C,T]=l.useState([]),[c,x]=l.useState([]),[k,g]=l.useState(!1),[$,a]=l.useState(""),[M,p]=l.useState(""),[ne,F]=l.useState(!1);l.useEffect(()=>{I()},[]);const I=async()=>{try{const t=localStorage.getItem("userType")==="teacher";F(t);let r,h;if(t){r=await X(),r.success&&(h=r.classes||[],_(h));const o=await Y();if(o.success){const m=[...new Set((o.classes||[]).map(E=>E.session))];v(m)}}else if(r=await Z(),r.success){h=[...new Set((r.classes||[]).map(m=>m.class_name))];const o=[...new Set((r.classes||[]).map(m=>m.session))];_(h),v(o)}try{const o=await ee();if(o.success&&o.data.current_session){const m=o.data.current_session;B(m),b.length>0&&!b.includes(m)&&v(E=>[m,...E]),S(m)}else b.length>0&&S(b[0])}catch{b.length>0&&S(b[0])}}catch(s){console.error("Error loading classes:",s)}},q=async s=>{if(s){g(!0);try{const t=await le();if(t.success){const r=t.data.filter(h=>{var o;return((o=h.current_class)==null?void 0:o.trim().toLowerCase())===s.trim().toLowerCase()});A(r)}}catch(t){a("Error loading students"),console.error("Load students error:",t)}finally{g(!1)}}},z=async s=>{if(s)try{const t=await ae(s);t.success&&T(t.data.subjects||[])}catch(t){console.error("Error loading class subjects:",t)}},R=s=>{const t=s.target.value;P(t),w(null),y([]),A([]),T([]),x([]),t&&(q(t),z(t))},U=async s=>{if(w(s),a(""),!u){a("Please select a session first");return}g(!0);try{const t=await se(s.id,u);if(t.success){const r=t.data.subjects.map(h=>h.subject_name);x(r)}}catch(t){console.error("Error loading student subjects:",t),x([])}finally{g(!1)}},W=s=>{const t=i.some(r=>r.id===s.id);y(t?i.filter(r=>r.id!==s.id):[...i,s])},G=()=>{y([...f])},H=()=>{y([])},J=()=>{D(!d),w(null),y([]),x([])},K=s=>{c.includes(s)?x(c.filter(t=>t!==s)):x([...c,s])},O=()=>{const s=C.map(t=>t.name);x(s)},Q=()=>{x([])},V=async()=>{if(d){if(i.length===0){a("Please select at least one student");return}if(!u){a("Please select a session first");return}if(c.length===0){a("Please select at least one subject");return}g(!0),a(""),p("");try{const s=i.map(r=>({student_id:r.id,subjects:c})),t=await te(s,u,j);t.success?(p(`Successfully enrolled ${i.length} student(s) in ${c.length} subject(s)!`),setTimeout(()=>p(""),3e3),y([]),x([])):a(t.message||"Failed to enroll students")}catch(s){a("Error saving bulk enrollment"),console.error("Save bulk enrollment error:",s)}finally{g(!1)}}else{if(!n){a("Please select a student");return}if(!u){a("Please select a session first");return}if(c.length===0){a("Please select at least one subject");return}g(!0),a(""),p("");try{const s=await re(n.id,c,u);s.success?(p(`Successfully enrolled ${n.name} in ${c.length} subject(s)!`),setTimeout(()=>p(""),3e3)):a(s.message||"Failed to enroll student")}catch(s){a("Error saving enrollment"),console.error("Save enrollment error:",s)}finally{g(!1)}}};return e.jsxs("div",{className:"px-4",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-1",children:"Manage Student Subjects"}),e.jsxs("p",{className:"text-gray-600",children:["Enroll students in their subjects for ",u||"a session"]})]}),$&&e.jsx("div",{className:"bg-red-50 border border-red-400 text-red-700 px-4 py-2 rounded mb-4",children:$}),M&&e.jsx("div",{className:"bg-green-50 border border-green-400 text-green-700 px-4 py-2 rounded mb-4",children:M}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Session"}),e.jsxs("select",{value:u,onChange:s=>S(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"Choose a session..."}),b.map((s,t)=>e.jsxs("option",{value:s,children:[s,s===N?" (Current)":""]},t))]}),N&&u===N&&e.jsx("p",{className:"text-xs text-primary-600 mt-1 font-medium",children:"✓ Using current session from school settings"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Class"}),e.jsxs("select",{value:j,onChange:R,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"",children:"Choose a class..."}),L.map((s,t)=>e.jsx("option",{value:s,children:s},t))]})]})]})}),j&&e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Students in ",j]}),e.jsx("button",{onClick:J,className:`text-xs px-2 py-1 rounded font-medium ${d?"bg-primary-600 text-white":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:d?"Bulk Mode":"Single"})]}),d&&f.length>0&&e.jsxs("div",{className:"flex gap-2 mb-3 text-xs",children:[e.jsx("button",{onClick:G,className:"text-primary-600 hover:text-primary-700 font-medium",children:"Select All"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{onClick:H,className:"text-gray-600 hover:text-gray-700 font-medium",children:"Deselect All"}),i.length>0&&e.jsxs("span",{className:"ml-auto text-primary-600 font-medium",children:[i.length," selected"]})]}),k&&f.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Loading students..."}):f.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No students found"}):e.jsx("div",{className:"space-y-2 max-h-[calc(100vh-280px)] overflow-y-auto",children:f.map(s=>{const t=d?i.some(r=>r.id===s.id):(n==null?void 0:n.admission_no)===s.admission_no;return d?e.jsxs("label",{className:`flex items-center w-full p-2 rounded-md border cursor-pointer transition-colors ${t?"bg-primary-50 border-primary-500":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"checkbox",checked:t,onChange:()=>W(s),className:"mr-2 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm truncate",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.admission_no})]})]},s.admission_no):e.jsxs("button",{onClick:()=>U(s),className:`w-full text-left p-2 rounded-md border transition-colors ${t?"bg-primary-50 border-primary-500":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("div",{className:"font-medium text-gray-900 text-sm",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.admission_no})]},s.admission_no)})})]})}),e.jsx("div",{className:"lg:col-span-2",children:n||d&&i.length>0?e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"Subject Enrollment"}),e.jsx("p",{className:"text-sm text-gray-600",children:d?`${i.length} student(s) selected`:`${n==null?void 0:n.name} - ${n==null?void 0:n.admission_no}`})]}),e.jsx("div",{className:"bg-primary-50 border border-primary-200 rounded-lg px-3 py-2",children:e.jsxs("p",{className:"text-sm text-primary-900",children:[e.jsx("strong",{children:c.length})," selected"]})})]}),C.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"No subjects configured for this class. Please configure class subjects first."}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex gap-2 mb-3",children:[e.jsx("button",{onClick:O,className:"text-sm text-primary-600 hover:text-primary-700 font-medium",children:"Select All"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{onClick:Q,className:"text-sm text-gray-600 hover:text-gray-700 font-medium",children:"Deselect All"})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 mb-4 max-h-[calc(100vh-350px)] overflow-y-auto",children:C.map((s,t)=>{const r=c.includes(s.name);return e.jsxs("label",{className:`flex items-center p-2 rounded-md border cursor-pointer transition-colors ${r?"bg-primary-50 border-primary-500":"bg-gray-50 border-gray-200 hover:bg-gray-100"}`,children:[e.jsx("input",{type:"checkbox",checked:r,onChange:()=>K(s.name),className:"mr-2 h-4 w-4 text-primary-600 border-gray-300 rounded focus:ring-primary-500"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("span",{className:"text-gray-900 font-medium text-sm block truncate",children:s.name}),e.jsx("span",{className:`inline-block text-xs px-2 py-0.5 rounded mt-1 ${s.is_core?"bg-primary-100 text-primary-700":"bg-gray-200 text-gray-700"}`,children:s.is_core?"Core":"Elective"})]})]},t)})}),e.jsx("button",{onClick:V,disabled:k||c.length===0,className:"w-full bg-primary-600 hover:bg-primary-700 text-white px-6 py-2 rounded-md font-medium disabled:opacity-50 disabled:cursor-not-allowed",children:k?"Saving...":"Save Enrollment"})]})]}):e.jsx("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-4",children:e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx("svg",{className:"mx-auto h-12 w-12 text-gray-400 mb-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"})}),e.jsx("p",{children:d?"Select student(s) to manage their subject enrollment":"Select a student to manage their subject enrollment"})]})})})]}),j&&e.jsxs("div",{className:"mt-4 bg-primary-50 border border-primary-200 rounded-lg p-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-primary-900 mb-1",children:"Instructions:"}),e.jsxs("ul",{className:"text-sm text-primary-800 space-y-0.5",children:[e.jsx("li",{children:"• Select a session (academic year) first"}),e.jsx("li",{children:"• Select a class to view students in that class"}),e.jsx("li",{children:'• Use "Bulk Mode" to assign the same subjects to multiple students at once'}),e.jsx("li",{children:"• In single mode, click on a student to manage their subject enrollment individually"}),e.jsx("li",{children:"• Check/uncheck subjects to enroll or unenroll the student(s)"}),e.jsx("li",{children:"• Core subjects are recommended but not enforced - students have full liberty to choose"})]})]})]})};export{ie as default};
